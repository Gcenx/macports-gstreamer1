# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4

PortSystem                  1.0
PortGroup                   meson 1.0

# https://bugzilla.gnome.org/show_bug.cgi?id=636134
PortGroup                   muniversal 1.0
PortGroup                   active_variants 1.1

name                        gstreamer1-gst-plugins-bad
set my_name                 gst-plugins-bad
# please only commit stable updates (even numbered releases)
version                     1.18.4
description                 A set of plug-ins for GStreamer that need more quality.
long_description            GStreamer Bad Plug-ins is a set of plug-ins that aren't up to par compared \
                            to the rest. They might be close to being good quality, but they're missing \
                            something - be it a good code review, some documentation, a set of tests, a \
                            real live maintainer, or some actual wide use.
license                     GPL LGPL
maintainers                 {gcenx @gcenx}
categories                  gnome
platforms                   darwin
homepage                    https://gstreamer.freedesktop.org/modules/${my_name}.html
master_sites                https://gstreamer.freedesktop.org/src/${my_name}/
distname                    ${my_name}-${version}
use_xz                      yes

checksums                   rmd160  b53cd88e800b18bc7a6a57de30e03b6c30e2fe83 \
                            sha256  74e806bc5595b18c70e9ca93571e27e79dfb808e5d2e7967afa952b52e99c85f \
                            size    5640292

set python_version          39
set python_branch           3.9

depends_build-append        port:pkgconfig \
                            port:python${python_version}

depends_lib                 port:gstreamer1-gst-plugins-base \
                            port:faac \
                            port:faad2 \
                            port:libfdk-aac \
                            port:gettext \
                            path:include/turbojpeg.h:libjpeg-turbo \
                            port:libmms \
                            port:libusrsctp \
                            port:openssl \
                            port:libopus \
                            port:orc \
                            port:rtmpdump \
                            port:libsrtp \
                            port:x265

configure.env-append        PATH=${frameworks_dir}/Python.framework/Versions/${python_branch}/bin:$env(PATH)
configure.python            ${prefix}/bin/python${python_branch}

#
# could depend on tons for multimedia stuff +variants
# the following ports are available but don't configure
# and/or build correctly
#
# port:mjpegtools (mpeg2enc mplex build fails) need to disable mpeg2enc mplex explicitly in case mjpegtools is installed
# port:faac has a restrictive license, disable faac plugin by default
# port:libfdk-aac has a restrictive license, disable fdkaac plugin by default
# plugin frei0r (no dependency, seqfaults on load)
# port:opencv (opencv plugin fails to configure with opencv 3.0.0+, can't find opencv2/bgsegm.hpp, now opencv2/video/background_segm.hpp)
# plugin opus is now contained in gstreamer1-gst-plugins-base, disable this version
# plugin ipcpipeline fails to build

# requires support for C11 (redefinition of typedef ‘GstTestHTTPSrc’ at elements/test_http_src.c:101)
compiler.c_standard 2011

configure.args-append       -Dapplemedia=disabled \
                            -Dfbdev=disabled \
                            -Ddecklink=disabled \
                            -Dchromaprint=disabled \
                            -Dcurl=disabled \
                            -Dcurl-ssh2=disabled \
                            -Dlinksys=disabled \
                            -Dstatic=disabled \
                            -Ddts=disabled \
                            -Dfaac=enabled \
                            -Dfaad=enabled \
                            -Dfdkaac=enabled \
                            -Dlibmms=disabled \
                            -Dmpeg2enc=disabled \
                            -Dmplex=disabled \
                            -Dneon=disabled \
                            -Drtmp=disabled \
                            -Dflite=disabled \
                            -Dvulkan=disabled \
                            -Dsbc=disabled \
                            -Dopencv=disabled \
                            -Dvoamrwbenc=disabled \
                            -Dx265=enabled \
                            -Dexamples=disabled \
                            -Dtests=disabled \
                            -Dgtk_doc=disabled \
                            -Dintrospection=disabled \
                            -Dgobject-cast-checks=disabled \
                            -Dglib-asserts=disabled \
                            -Dglib-checks=disabled \
                            -Dnls=disabled \
                            -Dbenchmarks=disabled

configure.cppflags-append   "-L${prefix}/lib"
configure.cflags-append     -std=c99 -funroll-loops -fstrict-aliasing
configure.env-append        "HAVE_CXX=yes"

# Window system is provided by gstreamer1-gst-plugins-base, so sync up.
variant x11 {
    require_active_variants port:gstreamer1-gst-plugins-base x11
}

livecheck.type              regex
livecheck.url               ${master_sites}
livecheck.regex             "${my_name}-(\\d+\\\.\\d*\[02468\](?:\\.\\d+)*)${extract.suffix}"
